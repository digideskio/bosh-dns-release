#!/bin/bash
set -euo pipefail

export DEPLOYMENT_NAME_PREFIX=<%= p('deployment_name_prefix') %>
export DEPLOYMENT_COUNT=<%= p('deployment_count') %>
export INSTANCE_COUNT=<%= p('instance_count') %>

failure=0
success=0

mkdir -p /var/vcap/sys/log/dns-lookuper/

for deployment_index in $(seq 1 $DEPLOYMENT_COUNT); do
  for instance_index in $(seq 0 $(($INSTANCE_COUNT-1))); do
    host="q-i${instance_index}.bosh-dns.default.${DEPLOYMENT_NAME_PREFIX}-${deployment_index}.bosh"
    dig_result="$(dig "${host}")"
    grep_for_query_success=$(echo ${dig_result} | grep "status:\sNOERROR")

    if [[ -z "${grep_for_query_success}" ]] ; then
      failure=$((failure+1))
      echo "Failed to lookup ${host}" >> /var/vcap/sys/log/dns-lookuper/stdout.log
      echo "${dig_result}" >> /var/vcap/sys/log/dns-lookuper/stdout.log

      # output some extra debug in case of failure
      dig upcheck.bosh-dns >> /var/vcap/sys/log/dns-lookuper/stdout.log
      uptime >> /var/vcap/sys/log/dns-lookuper/stdout.log
    else
      success=$((success+1))
    fi
  done
done


echo "Result: ${success} succeeded, ${failure} failed"

[[ $failure -eq 0 ]] || exit 1
